<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Web3 Marketplace</title>
<style>
  :root {
    --primary: #2874f0;
    --accent: #ffb300;
    --dark: #232f3e;
    --gray: #f4f4f4;
    --light: #ffffff;
    --success: #2a9d8f;
    --danger: #e53935;
  }
  body {
    margin: 0; background: var(--gray);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: var(--dark);
    padding: 1rem 2rem;
    color: var(--light);
    font-weight: bold;
    font-size: 1.6rem;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,.1);
  }
  nav.nav {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-top: 0.8rem;
    font-size: 1.1rem;
  }
  nav.nav a, nav.nav button {
    color: var(--light);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    transition: background 0.2s;
  }
  nav.nav a:hover, nav.nav button:hover {
    background: rgba(255,255,255,0.08);
  }
  .container {
    max-width: 900px;
    margin: 2rem auto 3rem auto;
    background-color: #ffffffdd;
    border-radius: 20px;
    box-shadow: 0 8px 16px rgba(38, 70, 83, 0.1);
    padding: 2rem 2.5rem;
    flex-grow: 1;
  }
  h2 {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
    padding-bottom: 0.6rem;
    margin-bottom: 1rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-align: center;
  }
  input, button, textarea {
    display: block;
    width: 100%;
    margin-bottom: 1.25rem;
    padding: 0.9rem 1.1rem;
    font-size: 1rem;
    border-radius: 14px;
    border: 1.8px solid #a8dadc;
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 8px rgba(40,116,240,0.35);
  }
  button {
    background-color: var(--primary);
    color: white;
    font-weight: 700;
    cursor: pointer;
    border: none;
    box-shadow: 0 5px 12px rgba(40,116,240,0.5);
    transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
  }
  button:hover {
    background-color: #1a52b8;
    box-shadow: 0 7px 16px rgba(26,82,184,0.75);
    transform: translateY(-2px);
  }
  button:active {
    transform: translateY(0);
    box-shadow: 0 4px 8px rgba(26,82,184,0.5);
  }
  .form-section {
    max-width: 420px;
    margin: 1rem auto;
    background: #f1faee;
    padding: 1.6rem 1.6rem 2rem 1.6rem;
    border-radius: 20px;
    box-shadow: 0 3px 8px rgba(38, 70, 83, 0.05);
    border: 1px solid #a8dadc;
  }
  .link-text {
    text-align: center;
    font-size: 0.93rem;
    margin-top: -1rem;
    margin-bottom: 1.25rem;
    color: #555;
  }
  .link-text span {
    color: var(--primary);
    cursor: pointer;
    text-decoration: underline;
  }
  #homeSection, #addProductSection, #dashboardSection {
    display: none;
  }
  #detailsModal {
    display: none; position: fixed; left:0; top:0; width:100vw; height:100vh;
    background: rgba(40,116,240,0.15); z-index: 22;
    justify-content: center; align-items: center;
  }
  #detailsModal.active { display: flex; }
  .modal-content {
    background: #fff; border-radius: 18px; box-shadow: 0 6px 40px rgba(40,116,240,.10);
    width: 400px; max-width: 95vw;
    padding: 2rem 2rem 1.2rem 2rem;
    position: relative;
  }
  .close-btn {
    position: absolute; top: 1rem; right: 1.2rem; cursor: pointer;
    font-weight: 700; color: #a8a8a8; font-size: 1.3rem;
  }
  .review-list { margin-top: 1.2rem;}
  .review-item { margin-bottom: 1rem; font-size: 1rem; }
  .review-user { font-weight: 700; display: inline-block; margin-right: 0.5em;}
  .review-rating { color:#fadb14; margin-left: 0.6em;}
  @media (max-width: 600px) {
    .product-grid { grid-template-columns: 1fr; }
    .modal-content { padding: 1rem; }
    .container, .form-section {
      margin: 1rem 0 2rem;
      border-radius: 10px;
      padding: 1.5rem 1.5rem 1.2rem;
    }
  }
</style>
</head>
<body>
<header>
  Web3 Marketplace
  <nav class="nav" id="navBar" style="display:none;">
    <a href="#" onclick="showSection('home')">Home</a>
    <a href="#" onclick="showSection('add-product')">Add Product</a>
    <a href="#" onclick="showSection('dashboard')">My Products</a>
    <button onclick="logoutUser()">Logout</button>
    <span id="walletAddress" style="color:#fff;margin-left:1rem;"></span>
  </nav>
</header>

<!-- AUTH -->
<div class="form-section" id="authSection">
  <div id="loginForm">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="loginUser()">Login</button>
    <div class="link-text">Don't have an account? <span onclick="toggleAuthForms()">Register here</span></div>
  </div>
  <div id="registerForm" style="display:none;">
    <h2>Register</h2>
    <input id="regUsername" placeholder="Username" />
    <input type="password" id="regPassword" placeholder="Password" />
    <button onclick="registerNewUser()">Register</button>
    <div class="link-text">Already have an account? <span onclick="toggleAuthForms()">Login here</span></div>
  </div>
  <div style="text-align:center; margin-top:10px;">
    <button onclick="connectWallet()">Connect Wallet</button>
  </div>
</div>

<!-- HOME SECTION -->
<div class="container" id="homeSection">
  <div class="search-bar" style="max-width:700px; margin:auto 0 1rem 0; display:flex; gap:0.5rem;">
    <input id="searchInput" placeholder="Search for products, IDs, manufacturer..." style="flex:1; padding:0.7rem; border-radius:7px; border:1.5px solid #bbb;" />
    <button onclick="searchProducts()" style="background: var(--primary); color:#fff; border:none; border-radius:7px; padding:0 1.2rem; font-weight:bold; cursor:pointer;">Search</button>
  </div>
  <div class="product-grid" id="productGrid"></div>
</div>

<!-- ADD PRODUCT -->
<div class="container" id="addProductSection" style="max-width:440px; margin:2rem auto;">
  <h2>Add a New Product</h2>
  <input id="newProductId" placeholder="Product ID" />
  <input id="newProductName" placeholder="Product Name" />
  <input id="newProductManufacturer" placeholder="Manufacturer" />
  <button class="add-product-btn" onclick="addProduct()">Add Product</button>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboardSection" style="max-width:600px; margin:2rem auto;">
  <h2>My Registered Products</h2>
  <div id="myProductList">Loading...</div>
</div>

<!-- PRODUCT DETAILS MODAL -->
<div class="modal" id="detailsModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2 id="modalName"></h2>
    <div><strong>Manufacturer:</strong> <span id="modalManufacturer"></span></div>
    <div><strong>Product ID:</strong> <span id="modalId"></span></div>
    <div><strong>Verified:</strong> <span id="modalVerified"></span></div>
    <button id="verifyBtn" class="verify-btn" onclick="verifySelectedProduct()">Verify Product</button>
    <h3 style="margin-top:1.4em;">Reviews</h3>
    <div class="review-list" id="reviewList"></div>
    <form onsubmit="addReview(event);" style="margin-top:1.3em;">
      <input id="reviewInput" maxlength="256" placeholder="Your review" required />
      <input id="ratingInput" type="number" min="1" max="5" value="5" required style="width: 90px; display: inline-block;" /> &nbsp;stars
      <button type="submit" style="margin-top:0.5em;">Add Review</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script>
  const contractAddress = "0x5f24fb08e759654167b2474311757444f2d587a2";
  const contractABI = [ /* all your ABI here exactly as provided */ ];

  let web3, contract, userAccount;
  let currentModalProductId = null;

  function toggleAuthForms() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    if(loginForm.style.display === 'none') {
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    } else {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
    }
  }

  async function connectWallet() {
    if(window.ethereum){
      web3 = new Web3(window.ethereum);
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
        document.getElementById('walletAddress').innerText = userAccount;
        alert("Wallet connected: " + userAccount);
      } catch(e) {
        console.error(e);
        alert("Failed connecting wallet");
      }
    } else {
      alert("MetaMask not detected");
    }
  }

  async function loginUser() {
    if(!contract) return alert("Connect wallet first");
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if(!username || !password) return alert("Fill all fields");
    try {
      const valid = await contract.methods.verifyUser(username, password).call({ from: userAccount });
      if(valid) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('navBar').style.display = 'flex';
        showSection('home');
        loadAllProducts();
        loadMyProducts();
      } else {
        alert("Invalid credentials");
      }
    } catch (err) {
      console.error(err);
      alert("Login failed: " + (err.message || ''));
    }
  }

  async function registerNewUser() {
    if(!contract) return alert("Connect wallet first");
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    if(!username || !password) return alert("Fill all fields");
    try {
      await contract.methods.registerUser(username, password).send({ from: userAccount });
      alert("Registration successful! Please login.");
      toggleAuthForms();
    } catch(err) {
      console.error(err);
      alert("Registration failed: " + (err.message || ''));
    }
  }

  function logoutUser() {
    document.getElementById('authSection').style.display = 'block';
    document.getElementById('navBar').style.display = 'none';
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('addProductSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'none';
    document.getElementById('walletAddress').innerText = '';
    userAccount = null;
  }

  function showSection(section) {
    document.getElementById('homeSection').style.display = section === 'home' ? 'block' : 'none';
    document.getElementById('addProductSection').style.display = section === 'add-product' ? 'block' : 'none';
    document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
    if(section === 'dashboard') loadMyProducts();
    if(section === 'home') loadAllProducts();
  }

  // Load all products (example implementation using ProductRegistered events)
  async function loadAllProducts() {
    const productGrid = document.getElementById('productGrid');
    productGrid.innerHTML = 'Loading...';

    try {
      // Fetch ProductRegistered events to get product IDs
      const events = await contract.getPastEvents('ProductRegistered', {
        fromBlock: 0,
        toBlock: 'latest'
      });
      let productIds = [...new Set(events.map(e => e.returnValues.productId))];

      if(productIds.length === 0) {
        productGrid.innerHTML = '<p>No products found.</p>';
        return;
      }

      productGrid.innerHTML = '';
      for (let id of productIds) {
        const [name, manufacturer, verified] = await contract.methods.getProduct(id).call();
        let card = document.createElement('div');
        card.className = 'product-card';
        card.style = 'background:#fff; padding:1rem; margin-bottom:1rem; border:1px solid #ddd; border-radius:8px;';
        card.innerHTML = `
          <div><strong>${name}</strong> (${verified ? 'Verified' : 'Not verified'})</div>
          <div>Manufacturer: ${manufacturer}</div>
          <div>ID: ${id}</div>
          <button onclick="openDetails('${id}')">Details & Reviews</button>
        `;
        productGrid.appendChild(card);
      }
    } catch(err) {
      console.error(err);
      productGrid.innerHTML = '<p>Error loading products</p>';
    }
  }

  async function loadMyProducts() {
    const container = document.getElementById('myProductList');
    if(!userAccount) {
      container.innerText = 'Please connect wallet.';
      return;
    }
    container.innerHTML = 'Loading...';

    try {
      // In your contract you do not track product ownership: 
      // you can fetch ProductRegistered events and filter by msg.sender if events include it (currently they don't)
      container.innerHTML = '<p>Feature not implemented: User product tracking requires contract enhancement or event filtering.</p>';
    } catch(err) {
      console.error(err);
      container.innerHTML = '<p>Error loading your products.</p>';
    }
  }

  async function addProduct() {
    if(!contract || !userAccount) return alert('Connect wallet first');
    const id = document.getElementById('newProductId').value.trim();
    const name = document.getElementById('newProductName').value.trim();
    const manufacturer = document.getElementById('newProductManufacturer').value.trim();

    if(!id || !name || !manufacturer) return alert('Fill all fields');

    try {
      await contract.methods.registerProduct(id, name, manufacturer).send({from: userAccount});
      alert('Product registered successfully!');
      document.getElementById('newProductId').value = '';
      document.getElementById('newProductName').value = '';
      document.getElementById('newProductManufacturer').value = '';
      showSection('home');
      loadAllProducts();
    } catch(err) {
      console.error(err);
      alert('Failed to register product: ' + (err.message || ''));
    }
  }

  async function openDetails(id) {
    currentModalProductId = id;
    const modal = document.getElementById('detailsModal');
    try {
      const [name, manufacturer, verified] = await contract.methods.getProduct(id).call();
      document.getElementById('modalName').textContent = name;
      document.getElementById('modalManufacturer').textContent = manufacturer;
      document.getElementById('modalId').textContent = id;
      document.getElementById('modalVerified').textContent = verified ? 'Yes' : 'No';
      document.getElementById('verifyBtn').style.display = verified ? 'none' : 'inline-block';

      // Load fraudReports used as reviews
      const reports = await contract.methods.getFraudReports(id).call();
      const reviewList = document.getElementById('reviewList');
      if(reports.length === 0) {
        reviewList.innerHTML = '<i>No reviews yet.</i>';
      } else {
        reviewList.innerHTML = reports.map(r => {
          return `<div class="review-item">
            <span class="review-user">${r.reporter}</span>: 
            <span>${r.description}</span>
          </div>`;
        }).join('');
      }

      modal.classList.add('active');
    } catch(err) {
      console.error(err);
      alert('Failed to load product details');
    }
  }

  function closeModal() {
    const modal = document.getElementById('detailsModal');
    modal.classList.remove('active');
    currentModalProductId = null;
  }

  async function verifySelectedProduct() {
    if(!currentModalProductId) return alert('No product selected');
    try {
      await contract.methods.verifyProduct(currentModalProductId).send({from: userAccount});
      alert('Product verified!');
      closeModal();
      loadAllProducts();
    } catch(err) {
      console.error(err);
      alert('Verification failed: ' + (err.message || ''));
    }
  }

  async function addReview(event) {
    event.preventDefault();
    if(!currentModalProductId) return alert('No product selected');
    const description = document.getElementById('reviewInput').value.trim();
    if(!description) return alert('Enter review text');
    try {
      await contract.methods.reportFraud(currentModalProductId, description).send({from: userAccount});
      alert('Review submitted!');
      document.getElementById('reviewInput').value = '';
      openDetails(currentModalProductId);  // Refresh details to show reviews
    } catch(err) {
      console.error(err);
      alert('Failed to submit review: ' + (err.message || ''));
    }
  }

  // Search placeholder (implement your own filtering logic as needed)
  function searchProducts() {
    alert('Search not implemented; implement based on your data or off-chain indexing');
  }

  function toggleAuthForms() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    if(loginForm.style.display === 'none') {
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    } else {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
    }
  }

  async function connectWallet() {
    if(window.ethereum) {
      web3 = new Web3(window.ethereum);
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
        document.getElementById('walletAddress').innerText = userAccount;
        alert("Wallet connected: " + userAccount);
      } catch(err) {
        alert('Failed connecting wallet');
        console.error(err);
      }
    } else {
      alert('MetaMask not detected');
    }
  }

  async function loginUser() {
    if(!contract) return alert('Connect wallet first');
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if(!username || !password) return alert('Fill all fields');
    try {
      const valid = await contract.methods.verifyUser(username, password).call({from: userAccount});
      if(valid) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('navBar').style.display = 'flex';
        showSection('home');
        loadAllProducts();
        loadMyProducts();
      } else {
        alert('Invalid credentials');
      }
    } catch(err) {
      console.error(err);
      alert('Login failed: ' + (err.message || ''));
    }
  }

  async function registerNewUser() {
    if(!contract) return alert('Connect wallet first');
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    if(!username || !password) return alert('Fill all fields');
    try {
      await contract.methods.registerUser(username, password).send({from: userAccount});
      alert('Registration successful! Please login.');
      toggleAuthForms();
    } catch(err) {
      console.error(err);
      alert('Registration failed: ' + (err.message || ''));
    }
  }

  function logoutUser() {
    document.getElementById('authSection').style.display = 'block';
    document.getElementById('navBar').style.display = 'none';
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('addProductSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'none';
    document.getElementById('walletAddress').innerText = '';
    userAccount = null;
  }

  function showSection(section) {
    document.getElementById('homeSection').style.display = section === 'home' ? 'block' : 'none';
    document.getElementById('addProductSection').style.display = section === 'add-product' ? 'block' : 'none';
    document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
    if(section === 'dashboard') loadMyProducts();
    if(section === 'home') loadAllProducts();
  }
</script>
</body>
</html>
